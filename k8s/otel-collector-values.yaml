# OpenTelemetry Collector Helm Values for Langfuse Integration
mode: deployment

# 이미지 설정
image:
  repository: otel/opentelemetry-collector-contrib

# 리소스 설정
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

# 서비스 설정
service:
  type: LoadBalancer

# 포트 설정
ports:
  otlp:
    enabled: true
    containerPort: 4317
    servicePort: 4317
    hostPort: 4317
    protocol: TCP
  otlp-http:
    enabled: true
    containerPort: 4318
    servicePort: 4318
    hostPort: 4318
    protocol: TCP

# Collector 설정
config:
  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: 0.0.0.0:4317
        http:
          endpoint: 0.0.0.0:4318
          cors:
            allowed_origins:
              - "*"
            allowed_headers:
              - "*"

  connectors:
    # 라우팅 커넥터: service.name 기반 분기
    # Note: routing connector는 resource context에서만 동작 (span attributes 접근 불가)
    routing/traces:
      default_pipelines: [traces/production]
      error_mode: ignore
      table:
        # Agent Lightning 전용 서비스명 패턴
        - condition: IsMatch(resource.attributes["service.name"], ".*agentlightning.*")
          pipelines: [traces/training]
        # service.name에 "training" 포함 시 학습 파이프라인으로
        - condition: IsMatch(resource.attributes["service.name"], ".*training.*")
          pipelines: [traces/training]
        # telemetry.sdk.name이 agentlightning인 경우
        - condition: resource.attributes["telemetry.sdk.name"] == "agentlightning"
          pipelines: [traces/training]

  processors:
    batch:
      timeout: 5s
      send_batch_size: 256
    memory_limiter:
      check_interval: 1s
      limit_mib: 400
      spike_limit_mib: 100
    # Attribute 길이 제한 해제
    transform:
      trace_statements:
        - context: span
          statements: []

  exporters:
    # debug exporter - basic: span 수만 표시, normal: 요약, detailed: 전체 내용
    debug:
      verbosity: basic
    
    # Langfuse OTLP Exporter (모든 트래픽)
    otlphttp/langfuse:
      endpoint: "http://langfuse-web.langfuse.svc.cluster.local:3000/api/public/otel"
      headers:
        Authorization: "Basic <REPLACE_WITH_BASE64_ENCODED_LANGFUSE_CREDENTIALS>"
      compression: gzip
    
    # Azure Application Insights - 프로덕션 모니터링용
    azuremonitor/production:
      connection_string: "InstrumentationKey=<YOUR_PRODUCTION_INSTRUMENTATION_KEY>;IngestionEndpoint=<YOUR_PRODUCTION_INGESTION_ENDPOINT>"
    
    # Azure Application Insights - RL 학습 모니터링용 (별도 App Insights)
    # TODO: 학습용 App Insights 생성 후 connection_string 교체
    azuremonitor/training:
      connection_string: "InstrumentationKey=<YOUR_TRAINING_INSTRUMENTATION_KEY>;IngestionEndpoint=<YOUR_TRAINING_INGESTION_ENDPOINT>"

  service:
    # Telemetry 설정 - attribute 길이 제한 늘리기
    telemetry:
      logs:
        level: info
      # OTLP Exporter의 attribute 값 길이 제한 해제
      resource:
        "service.name": "otel-collector"
    pipelines:
      # 입구 파이프라인: 모든 트래픽 수신 → 라우팅 커넥터로 전달
      traces:
        receivers: [otlp]
        processors: [memory_limiter, batch]
        exporters: [routing/traces]
      
      # 프로덕션 파이프라인: 웹 서비스 트래픽
      traces/production:
        receivers: [routing/traces]
        processors: []
        exporters: [otlphttp/langfuse, azuremonitor/production]
      
      # 학습 파이프라인: RL 학습 트래픽
      traces/training:
        receivers: [routing/traces]
        processors: []
        exporters: [otlphttp/langfuse, azuremonitor/training]

# 환경 변수로 attribute 길이 제한 설정 (중요!)
extraEnvs:
  - name: OTEL_ATTRIBUTE_VALUE_LENGTH_LIMIT
    value: "65535"
  - name: OTEL_SPAN_ATTRIBUTE_VALUE_LENGTH_LIMIT
    value: "65535"
