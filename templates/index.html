<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher-Student Quiz</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .quiz-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin: 2px;
        }
        .badge-teacher { background: #e3f2fd; color: #1565c0; }
        .badge-student { background: #f3e5f5; color: #7b1fa2; }
        .badge-difficulty { background: #fff3e0; color: #ef6c00; }
        .badge-subject { background: #e8f5e9; color: #2e7d32; }
        .quiz-info {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        .message.assistant {
            white-space: pre-wrap;
        }
        .message strong {
            display: block;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-header-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                </svg>
            </div>
            <h1>Teacher-Student Quiz</h1>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-container" id="welcomeContainer">
                <div class="welcome-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                </div>
                <h2 class="welcome-title">ğŸ“ Teacher-Student í€´ì¦ˆ</h2>
                <p class="welcome-subtitle">Teacherê°€ ë¬¸ì œë¥¼ ì¶œì œí•˜ê³ , Studentê°€ í’€ì´í•©ë‹ˆë‹¤.<br>ë‚œì´ë„ì™€ ì˜ì—­ì„ ì„ íƒí•´ ì‹œì‘í•˜ì„¸ìš”!</p>
                <div class="suggestions">
                    <button class="suggestion" onclick="useSuggestion('ì‰¬ìš´ ìˆ˜í•™ ë¬¸ì œ')">ğŸ”¢ ì‰¬ìš´ ìˆ˜í•™</button>
                    <button class="suggestion" onclick="useSuggestion('ë³´í†µ ê³¼í•™ ë¬¸ì œ')">ğŸ”¬ ë³´í†µ ê³¼í•™</button>
                    <button class="suggestion" onclick="useSuggestion('ì–´ë ¤ìš´ ì—­ì‚¬ í€´ì¦ˆ')">ğŸ“œ ì–´ë ¤ìš´ ì—­ì‚¬</button>
                    <button class="suggestion" onclick="useSuggestion('ì‰¬ìš´ ì˜ì–´ ë¬¸ì œ')">ğŸ”¤ ì‰¬ìš´ ì˜ì–´</button>
                    <button class="suggestion" onclick="useSuggestion('ë³´í†µ í”„ë¡œê·¸ë˜ë° í€´ì¦ˆ')">ğŸ’» ë³´í†µ í”„ë¡œê·¸ë˜ë°</button>
                    <button class="suggestion" onclick="useSuggestion('ì‰¬ìš´ ì¼ë°˜ìƒì‹')">ğŸ’¡ ì‰¬ìš´ ì¼ë°˜ìƒì‹</button>
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <div class="input-wrapper">
                <input type="text" class="chat-input" id="chatInput" placeholder="ë‚œì´ë„ì™€ ì˜ì—­ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë³´í†µ ìˆ˜í•™)" autocomplete="off">
                <button class="send-button" id="sendButton">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <script>
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const welcomeContainer = document.getElementById('welcomeContainer');
        let isFirstMessage = true;
        let sessionId = null;
        
        function useSuggestion(text) {
            chatInput.value = text;
            sendMessage();
        }
        
        function formatMessage(content) {
            // Markdown boldë¥¼ HTMLë¡œ ë³€í™˜
            return content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }
        
        function getNodeIcon(node) {
            const icons = {
                'setup': 'âš™ï¸',
                'teacher_question': 'ğŸ‘¨â€ğŸ«',
                'student_answer': 'ğŸ§‘â€ğŸ“',
                'teacher_evaluate': 'ğŸ“'
            };
            return icons[node] || 'ğŸ’¬';
        }
        
        function getNodeLabel(node) {
            const labels = {
                'setup': 'ì„¤ì •',
                'teacher_question': 'Teacher ë¬¸ì œ',
                'student_answer': 'Student ë‹µë³€',
                'teacher_evaluate': 'Teacher í‰ê°€'
            };
            return labels[node] || node;
        }
        
        function addMessage(content, type, node = null) {
            if (isFirstMessage) {
                welcomeContainer.style.display = 'none';
                isFirstMessage = false;
            }
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            if (type === 'assistant' && node) {
                // ë…¸ë“œë³„ ìŠ¤íƒ€ì¼ë§
                messageDiv.classList.add(`node-${node}`);
            }
            
            if (type === 'assistant') {
                messageDiv.innerHTML = formatMessage(content);
            } else {
                messageDiv.textContent = content;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }
        
        function createStreamingMessage(node, label = '') {
            if (isFirstMessage) {
                welcomeContainer.style.display = 'none';
                isFirstMessage = false;
            }
            
            // í—¤ë” í‘œì‹œ
            if (label) {
                const headerDiv = document.createElement('div');
                headerDiv.className = 'agent-header';
                headerDiv.innerHTML = `<span class="agent-label node-label-${node}">${label}</span>`;
                chatMessages.appendChild(headerDiv);
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message assistant node-${node} streaming`;
            messageDiv.innerHTML = '<span class="cursor">â–Œ</span>';
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }
        
        function showTypingIndicator(text = '') {
            hideTypingIndicator();
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            if (text) {
                typingDiv.innerHTML = `<span class="typing-text">${text}</span><span></span><span></span><span></span>`;
            } else {
                typingDiv.innerHTML = '<span></span><span></span><span></span>';
            }
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function hideTypingIndicator() {
            const el = document.getElementById('typingIndicator');
            if (el) el.remove();
        }
        
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            addMessage(message, 'user');
            chatInput.value = '';
            sendButton.disabled = true;
            chatInput.disabled = true;
            
            try {
                // SSE ìŠ¤íŠ¸ë¦¬ë° ì‚¬ìš©
                const response = await fetch('/chat/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, session_id: sessionId }),
                });
                
                if (!response.ok) throw new Error('Failed to get response');
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let currentNode = null;
                let currentMessageDiv = null;
                let currentContent = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.type === 'session') {
                                    sessionId = data.session_id;
                                } else if (data.type === 'node_start') {
                                    // ìƒˆ ë…¸ë“œ ì‹œì‘ - í—¤ë”ì™€ í•¨ê»˜ ë©”ì‹œì§€ ë°•ìŠ¤ ìƒì„±
                                    hideTypingIndicator();
                                    currentNode = data.node;
                                    currentContent = '';
                                    currentMessageDiv = createStreamingMessage(data.node, data.label);
                                } else if (data.type === 'token') {
                                    // í† í° ë‹¨ìœ„ë¡œ ì¶”ê°€
                                    if (currentMessageDiv && data.node === currentNode) {
                                        currentContent += data.content;
                                        currentMessageDiv.innerHTML = formatMessage(currentContent) + '<span class="cursor">â–Œ</span>';
                                        chatMessages.scrollTop = chatMessages.scrollHeight;
                                    }
                                } else if (data.type === 'node_end') {
                                    // ë…¸ë“œ ì™„ë£Œ - ì»¤ì„œ ì œê±°
                                    if (currentMessageDiv) {
                                        currentMessageDiv.innerHTML = formatMessage(currentContent);
                                        currentMessageDiv.classList.remove('streaming');
                                    }
                                } else if (data.type === 'waiting') {
                                    // ë‹¤ìŒ ë…¸ë“œ ëŒ€ê¸° í‘œì‹œ
                                    showTypingIndicator(data.message);
                                } else if (data.type === 'message') {
                                    // ì „ì²´ ë©”ì‹œì§€
                                    hideTypingIndicator();
                                    currentNode = data.node;
                                    currentContent = data.content;
                                    
                                    // ì—ì´ì „íŠ¸ ë…¸ë“œì¸ ê²½ìš° í—¤ë” ì—†ì´ ì§ì ‘ ì¶”ê°€ (node_startì—ì„œ ì´ë¯¸ ì¶”ê°€ë¨)
                                    if (['teacher_question', 'student_answer', 'teacher_evaluate'].includes(data.node)) {
                                        if (currentMessageDiv) {
                                            currentMessageDiv.innerHTML = formatMessage(currentContent);
                                        }
                                    } else {
                                        // setup ë“± ë‹¤ë¥¸ ë…¸ë“œ
                                        currentMessageDiv = addMessage(currentContent, 'assistant', data.node);
                                    }
                                } else if (data.type === 'done') {
                                    hideTypingIndicator();
                                    // placeholder ì—…ë°ì´íŠ¸
                                    if (currentContent && currentContent.includes('ë‹¤ìŒ ë¬¸ì œë¥¼ ì›í•˜ì‹œë©´')) {
                                        chatInput.placeholder = "'ë‹¤ìŒ' ë˜ëŠ” 'ìƒˆë¡œ ì‹œì‘' ì…ë ¥";
                                    } else if (currentContent && currentContent.includes('ë‚œì´ë„')) {
                                        chatInput.placeholder = "ë‚œì´ë„ì™€ ì˜ì—­ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë³´í†µ ìˆ˜í•™)";
                                    }
                                } else if (data.type === 'error') {
                                    hideTypingIndicator();
                                    addMessage(`ì˜¤ë¥˜: ${data.message}`, 'error');
                                }
                            } catch (e) {
                                // JSON íŒŒì‹± ì—ëŸ¬ ë¬´ì‹œ
                            }
                        }
                    }
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.', 'error');
                console.error('Error:', error);
            } finally {
                sendButton.disabled = false;
                chatInput.disabled = false;
                chatInput.focus();
            }
        }
        
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        chatInput.focus();
    </script>
</body>
</html>
